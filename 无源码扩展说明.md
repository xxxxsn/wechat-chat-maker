# 无源码扩展说明（Vue dist 项目）

本项目是 Vue 2 的打包结果（仅有 dist），没有源代码时可通过以下方式增加方法或数据。

## 原理

- Vue 2 会把根实例挂在根 DOM 的 `__vue__` 上。
- 在页面中在 **chat.bundle.js 之后** 加载扩展脚本，等 Vue 挂载完成后：
  - 用 `document.getElementById('vueApp').__vue__` 拿到根实例 `app`。
  - 用 `app.constructor` 得到 Vue 构造函数，便于使用 `Vue.set` 做响应式新增。

## 推荐做法

### 1. 使用 `static/app/js/extend.js`（已接入）

- **index.html** 中已在 `chat.bundle.js` 后引入：`<script src="static/app/js/extend.js"></script>`。
- 所有“无源码扩展”逻辑都写在 **extend.js** 里，便于维护，且不用改 bundle。

### 2. 在 extend.js 里增加方法

- **新增响应式数据**：用 `Vue.set`，否则界面不会更新。
  ```js
  Vue.set(app.setting, 'new_field', '');
  // 或根级：Vue.set(app, 'myFlag', false);
  ```
- **新增方法**：直接挂到根实例上。
  ```js
  app.myNewMethod = function () {
    // 可访问 app.users、app.dialogs、app.setting 等
  };
  ```

### 3. 在 index.html 里增加界面

- 在 `#vueApp` 内的模板里加 HTML，使用 Vue 指令绑定你在 extend.js 里加的数据和方法：
  - `v-model="setting.xxx"`、`@click="myNewMethod"` 等。
- 绑定的名字与 extend.js 里挂到 `app` / `app.setting` 上的一致即可。

### 4. 执行时机与“方法未定义”问题

- extend.js 里已用延迟 + 重试等待 `app.setting` 存在后再注入，避免 Vue 未挂载就执行。
- **重要**：模板在编译时就会把 `@click="addLinkDialog"` 等写进渲染函数，若方法在 300ms 后才注入，会报 `ReferenceError: addLinkDialog is not defined`。推荐两种做法：
  1. **延后渲染 + 全局调用**（当前图文做法）：用 `v-if="setting._linkReady"` 包裹扩展表单；在 extend.js 里先注入方法、再设 `window.__addLinkDialog` / `window.__onLinkImageChange` 指向实例方法、最后 `Vue.set(app.setting, '_linkReady', true)`；模板里**不用** `@click="addLinkDialog"`，改用原生 `onclick="window.__addLinkDialog && window.__addLinkDialog()"`，这样编译阶段不会出现未定义的符号。
  2. 或仅延后渲染：`v-if="setting._linkReady"` + 先注入方法再设 `_linkReady`；若仍报错，说明当前打包方式下渲染函数会提前引用方法，请改用做法 1。
- 若仍遇“拿不到实例”，可适当增大延迟或重试次数（见 `whenReady(extend, delay, maxRetry)`）。

## 调试

- 控制台可执行 `getVueApp()` 查看当前根实例（extend.js 已暴露）。
- 用 `getVueApp().users`、`getVueApp().dialogs` 等查看数据结构，再在 extend.js 里按需扩展。

## 其他方式（可选）

- **用户脚本**：若仅自己用，可用 Tampermonkey 等在页面 load 后执行类似逻辑（同样通过 `__vue__` 拿实例）。
- **不推荐**：直接改 chat.bundle.js（压缩且难读，升级易丢失）。
